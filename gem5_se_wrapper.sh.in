#!/bin/bash

set -e
set -o pipefail

usage() {
    cat <<EOF
usage: $0 -h
       $0 --host [--] command [arg...]
       $0 outprefix testpath -- gem5-args... -- se-args... -- command [arg...]
EOF
}

if [[ $# -eq 0 ]]; then
    usage >&2
    exit 1
fi

if [[ "$1" = "-h" ]]; then
    usage
    exit
fi

if [[ "$1" = "--host" ]]; then
    shift 1
    if [[ "$1" == "--" ]]; then
	shift 1
    fi
    "$@"
    exit $?
fi

if [[ $# -lt 2 ]]; then
    usage >&2
    exit 1
fi

outprefix="$1"
shift 1
testpath="$1"
shift 1

if [[ "$1" != "--" ]]; then
    usage >&2
    exit 1
fi
shift 1

gem5_bin_args=()
while [[ $# -gt 0 && "$1" != "--" ]]; do
    gem5_bin_args+=("$1")
    shift 1
done
if [[ "$1" != "--" ]]; then
    usage >&2
    exit 1
fi

se_args=()
while [[ $# -gt 0 && "$1" != "--" ]]; do
    se_args+=("$1")
    shift 1
done
if [[ "$1" != "--" ]]; then
    usage >&2
    exit 1
fi
shift 1

if [[ $# -eq 0 ]]; then
    echo 'missing command to execute' >&2
    usage >&2
    exit 1
fi

bin="$1"
shift 1

testname=$(basename ${testpath} .test)
outdir="${outprefix}${testname}"
trap "cat ${outdir}/stdout; cat ${outdir}/stderr >&2" EXIT
"@GEM5_BINARY@" "${gem5_args[@]}" --outdir="${outdir}" "@gem5_se_py@" "${se_args[@]}" --cmd="${bin}" --options="$*" --output="${outdir}/stdout" --errout="${outdir}/stderr" \
		> "${outdir}/simout" 2> "${outdir}/simerr"
@
